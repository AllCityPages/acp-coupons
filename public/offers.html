<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Local Deals Hub</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#ffd400">
  <!-- If your deployed CSS uses a different version, change v=29a to match -->
  <link rel="stylesheet" href="/theme.css?v=29a">
</head>
<body>
  <div class="site">
    <header class="header">
      <div class="logo" data-logo>LD</div>
      <div class="title">
        <h1>Local Deals Hub</h1>
        <p>Precision Beats Saturation ‚Äî Every Scan Counts.‚Ñ¢</p>
      </div>
    </header>

    <div class="actionbar">
      <button id="btn-near" class="chip chip--white">üìç Show deals near me</button>
      <a class="chip chip--white" href="/wallet.html?v=28">üí∞ My Wallet</a>
      <a class="chip chip--white" href="/wallet.html?v=28&tab=favorites">‚≠ê My Favorites</a>
    </div>

    <div class="filters">
      <input id="q" class="input" placeholder="Search offers or brand">
      <select id="brand" class="select"><option value="">All brands</option></select>
      <select id="category" class="select" aria-label="Categories"><option value="">All categories</option></select>
      <button id="apply" class="btn-compact">Apply</button>
      <button id="clear" class="btn-compact">Clear</button>
    </div>

    <section id="grid" class="grid">
      <noscript><p style="padding:10px">Enable JavaScript to view offers.</p></noscript>
    </section>

    <footer class="footer">AllCityPages.com | info@AllCityPages.com</footer>
  </div>

  <!-- ========= INLINE Shared (no external /shared.js needed) ========= -->
  <script>
  // Shared ‚Äî v31.2 (inline)
  const BRAND = { name:'Local Deals Hub', logo:'/logo.png', home:'/offers.html' };

  const Shared = (function(){
    const LS_FAV='acp_favorites_v1', LS_WAL='acp_wallet_v1';
    const QKEYS=['q','brand','category','sortNearby'];
    let _statsCache=null;
    let _nearby={ lat:null, lng:null, brandDist:new Map() };

    /* -------- utils -------- */
    const debounce=(fn,ms=300)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
    function readQuery(){const u=new URL(location.href);const st={};for(const k of QKEYS){if(u.searchParams.has(k)) st[k]=u.searchParams.get(k);} if(st.sortNearby!=null) st.sortNearby = st.sortNearby==='true'; return st;}
    function writeQuery(state){const u=new URL(location.href);QKEYS.forEach(k=>{if(state[k]==null||state[k]===''||state[k]===false)u.searchParams.delete(k);else u.searchParams.set(k,String(state[k]));});history.replaceState(null,'',u.toString());}

    /* -------- branding -------- */
    function initBranding(){
      document.querySelectorAll('[data-logo]').forEach(el=>{
        if (BRAND.logo){ el.classList.add('has-img'); el.innerHTML=`<img src="${BRAND.logo}" alt="${BRAND.name||'Logo'}">`; }
        else { el.textContent=(BRAND.name||'A').slice(0,1).toUpperCase(); }
      });
      const h1=document.querySelector('.title h1'); if(BRAND.name && h1 && !h1.dataset.locked) h1.textContent=BRAND.name;
    }

    /* -------- storage -------- */
    function loadSet(k){try{const raw=localStorage.getItem(k);if(!raw)return new Set();const arr=JSON.parse(raw);return new Set(Array.isArray(arr)?arr:[]);}catch(_){return new Set();}}
    function saveSet(k,s){localStorage.setItem(k,JSON.stringify(Array.from(s)));}
    let _fav=loadSet(LS_FAV), _wal=loadSet(LS_WAL);

    /* -------- stats -------- */
    async function getStats(){ if(_statsCache) return _statsCache; try{ _statsCache = await fetch('/api/offer-stats').then(r=>r.json()).then(x=>x.stats||{});}catch{ _statsCache = {}; } return _statsCache; }

    /* -------- distance helpers -------- */
    const toRad=d=>d*Math.PI/180;
    function haversineKm(a,b,c,d){const R=6371;const dLat=toRad(c-a),dLng=toRad(d-b);const A=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLng/2)**2;return R*2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));}
    function goodCoord(lat,lng){ if(lat==null||lng==null) return false; if(!isFinite(lat)||!isFinite(lng)) return false; if(Math.abs(lat)<0.1 && Math.abs(lng)<0.1) return false; return true; }
    function safeMiles(km,maxMiles=200){ if(!isFinite(km)) return ''; const mi=km*0.621371; if(mi>maxMiles) return ''; return (mi<10?mi.toFixed(1):Math.round(mi))+' mi'; }

    function normalizeAddresses(o){
      let list=[]; if(Array.isArray(o.addresses)) list=[...o.addresses]; else if(o.address) list=[o.address];
      return list.map(entry=>{
        if (typeof entry==='string') return { label:entry };
        const label = entry.label || [entry.street, entry.city, entry.state].filter(Boolean).join(', ');
        return { label, lat:entry.lat, lng:entry.lng };
      }).filter(a=>a && a.label);
    }

    function nearestAddress(o){
      const addrs=normalizeAddresses(o);
      if(!addrs.length || !goodCoord(_nearby.lat,_nearby.lng)) return null;
      let bestIdx=-1, bestKm=Infinity;
      addrs.forEach((a,i)=>{
        if(isFinite(a.lat)&&isFinite(a.lng) && goodCoord(a.lat,a.lng)){
          const km=haversineKm(_nearby.lat,_nearby.lng,a.lat,a.lng);
          if(km<bestKm){ bestKm=km; bestIdx=i; }
        }
      });
      if(bestIdx<0) return null;
      return { index:bestIdx, distanceKm:bestKm, address:addrs[bestIdx], all:addrs };
    }

    async function computeNearbySort(){
      if(!navigator.geolocation) return;
      const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:10000})).catch(()=>null);
      if(!pos) return;
      const lat=pos.coords.latitude, lng=pos.coords.longitude;
      if(!goodCoord(lat,lng)) return;
      _nearby.lat=lat; _nearby.lng=lng;
      const list = await fetch(`/api/nearby?lat=${lat}&lng=${lng}&radiusKm=50`).then(r=>r.json()).then(x=>x.stores||[]).catch(()=>[]);
      _nearby.brandDist=new Map(); list.forEach(s=>{ if(isFinite(s.distanceKm)) _nearby.brandDist.set((s.brand||'').toLowerCase(), s.distanceKm); });
    }

    function sortByNearby(rows){
      if(!_nearby.brandDist || !_nearby.brandDist.size) return rows;
      return rows.slice().sort((a,b)=>{
        const da=_nearby.brandDist.get((a.restaurant||'').toLowerCase()) ?? Infinity;
        const db=_nearby.brandDist.get((b.restaurant||'').toLowerCase()) ?? Infinity;
        return da-db;
      });
    }

    /* -------- UI helpers -------- */
    function populateBrandFilter(rows, selectEl){
      const brands=[...new Set(rows.map(r=>r.restaurant).filter(Boolean))].sort();
      brands.forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; selectEl.appendChild(o); });
    }

    function applyFilter(rows, state){
      const q=(state.q||'').toLowerCase();
      const brand=state.brand||'';
      const cat=(state.category||'').toLowerCase();
      return rows.filter(r=>{
        const hitsQ=!q || `${r.title} ${r.restaurant} ${r.description||''}`.toLowerCase().includes(q);
        const hitsB=!brand || r.restaurant===brand;
        const hitsC=!cat || cat==='all' || (r.category||'').toLowerCase()===cat;
        return hitsQ && hitsB && hitsC;
      });
    }

    function isFavorite(id){ return _fav.has(String(id)); }
    function isInWallet(id){ return _wal.has(String(id)); }
    function toggleFavorite(id){ id=String(id); _fav.has(id)?_fav.delete(id):_fav.add(id); saveSet(LS_FAV,_fav); }
    function toggleWallet(id){ id=String(id); _wal.has(id)?_wal.delete(id):_wal.add(id); saveSet(LS_WAL,_wal); }

    function updateButtonsFor(id){
      id=String(id);
      document.querySelectorAll(`.btn-fav[data-offer-id="${id}"]`).forEach(b=>{
        if(isFavorite(id)){ b.classList.add('btn-on'); b.textContent='Saved ‚úì'; }
        else { b.classList.remove('btn-on'); b.textContent='‚≠ê Favorite'; }
      });
      document.querySelectorAll(`.btn-wallet[data-offer-id="${id}"]`).forEach(b=>{
        if(isInWallet(id)){ b.classList.add('btn-on'); b.textContent='Saved ‚úì'; }
        else { b.classList.remove('btn-on'); b.textContent='Add to Wallet'; }
      });
    }

    /* -------- CARD (matches your theme.css v29a expectations) -------- */
    function makeCard(o, opts={}){
      const stats = (_statsCache && _statsCache[o.id]) ? _statsCache[o.id] : {issued:0, redeemed:0};
      const exp   = expiryInfo(o);

      const el=document.createElement('article'); el.className='card'; el.dataset.offerId=String(o.id);

      // Hero
      const hero=document.createElement('div'); hero.className='hero hero--zoom';
      if(o.hero_nozoom===true) hero.classList.remove('hero--zoom');
      const img=document.createElement('img'); img.className='img'; img.src=o.hero_image||''; img.alt=o.title||'';
      hero.appendChild(img); el.appendChild(hero);

      // Body
      const body=document.createElement('div'); body.className='body'; el.appendChild(body);

      // Title grid row (your CSS hooks)
      const titleRow=document.createElement('div'); titleRow.className='title-row';

      // Title (column 1, centered between logo top & mileage bottom by CSS)
      const h3=document.createElement('h3'); h3.textContent=o.title||o.id;
      titleRow.appendChild(h3);

      // Right stack (column 2): logo + mileage
      const stack=document.createElement('div'); stack.className='brand-logo-stack';
      if(o.logo){
        const logo=document.createElement('img'); logo.className='brand-logo-inline'; logo.src=o.logo; logo.alt=(o.restaurant||'Brand')+' logo';
        stack.appendChild(logo);
      }
      const distEl=document.createElement('div'); distEl.className='brand-distance';
      let distText='';
      const near=nearestAddress(o);
      if(near && isFinite(near.distanceKm)) distText=safeMiles(near.distanceKm);
      else if(_nearby.brandDist && _nearby.brandDist.size){
        const d=_nearby.brandDist.get((o.restaurant||'').toLowerCase()); if(isFinite(d)) distText=safeMiles(d);
      }
      distEl.textContent=distText; if(distText) stack.appendChild(distEl);
      titleRow.appendChild(stack);

      // Includes line (column 1 baseline; aligns with mileage by CSS)
      const includes=(o.includes || o.Includes || o.bundle || '').trim();
      const inc=document.createElement('div'); inc.className='includes-row';
      if(includes){ inc.textContent='Includes: '+includes; inc.style.display=''; } else { inc.style.display='none'; }
      titleRow.appendChild(inc);

      // Brand row ABOVE the title row
      const brandRow=document.createElement('div'); brandRow.className='brand-row';
      const brand=document.createElement('div'); brand.className='brand'; brand.textContent=o.restaurant||'';
      brandRow.appendChild(brand);
      body.appendChild(brandRow);
      body.appendChild(titleRow);

      // Address block
      (function renderAddress(){
        const info=nearestAddress(o);
        const addrs=normalizeAddresses(o);
        if(!addrs.length) return;

        const addr=document.createElement('div'); addr.className='addr';
        if(info){
          const sm=safeMiles(info.distanceKm);
          addr.innerHTML = `${info.address.label}` + (sm ? ` <span class="addr-dist">‚Ä¢ ${sm} away</span>` : '') +
                           (addrs.length>1 ? ` <small class="toggle" role="button" tabindex="0">(view all)</small>` : '');
        }else{
          addr.textContent = addrs[0].label + (addrs.length>1 ? ` (+${addrs.length-1} more)` : '');
        }
        body.appendChild(addr);

        if(addrs.length>1){
          const list=document.createElement('div'); list.className='addr-list';
          addrs.forEach(a=>{
            let line=a.label;
            if(isFinite(a.lat)&&isFinite(a.lng)&&goodCoord(_nearby.lat,_nearby.lng)){
              const km=haversineKm(_nearby.lat,_nearby.lng,a.lat,a.lng);
              const sm=safeMiles(km); if(sm) line += ` ‚Äî ${sm}`;
            }
            const item=document.createElement('div'); item.textContent=line; list.appendChild(item);
          });
          body.appendChild(list);

          const toggle=addr.querySelector('.toggle');
          if(toggle){
            toggle.addEventListener('click', ()=> list.classList.toggle('show'));
            toggle.addEventListener('keydown', e=>{
              if(e.key==='Enter'||e.key===' '){ e.preventDefault(); list.classList.toggle('show'); }
            });
          }
        }
      })();

      // Description
      if(o.description){ const p=document.createElement('p'); p.className='desc'; p.textContent=o.description; body.appendChild(p); }

      // Badges
      const meta=document.createElement('div'); meta.className='meta';
      const expb=document.createElement('span'); expb.className=`badge ${exp.cls}`; expb.textContent=exp.label; meta.appendChild(expb);
      const redb=document.createElement('span'); redb.className='badge ok'; redb.textContent=`${(stats.redeemed||0)} redeemed`; meta.appendChild(redb);
      body.appendChild(meta);

      // Buttons
      const row=document.createElement('div'); row.className='btnrow'; body.appendChild(row);
      const cta=document.createElement('a'); cta.className='btn btn-cta'; cta.textContent=opts.wallet?'Use Now':'Tap to Redeem'; cta.href=`/coupon?offer=${encodeURIComponent(o.id)}`; if(exp.expired){ cta.setAttribute('disabled',''); cta.href='javascript:void(0)'; } row.appendChild(cta);
      const fav=document.createElement('button'); fav.className='btn btn-fav'; fav.dataset.action='fav'; fav.dataset.offerId=String(o.id); row.appendChild(fav);
      const wal=document.createElement('button'); wal.className='btn btn-wallet'; wal.dataset.action='wallet'; wal.dataset.offerId=String(o.id); row.appendChild(wal);
      const print=document.createElement('a'); print.className='btn btn-outline'; print.textContent='Print'; print.href=`/coupon-print.html?offer=${encodeURIComponent(o.id)}&src=card`; row.appendChild(print);

      updateButtonsFor(o.id);
      return el;
    }

    /* -------- misc -------- */
    function expiryInfo(o){
      const days=Number(o.expires_days||0);
      const remaining=Math.max(0,Math.floor(days));
      let cls='warn', label=`Expires in ${remaining} days`;
      if(remaining<=3 && remaining>0){ cls='danger'; label=`Expires in ${remaining} day${remaining===1?'':'s'}`; }
      if(remaining===0){ cls='neutral'; label='Expired'; }
      return {remaining,cls,label,expired:remaining===0};
    }

    function suggest(all,state,n=8){
      const inWallet=new Set(Array.from(_wal));
      const pool=all.filter(o=>!inWallet.has(String(o.id)));
      const cat=(state.category||'').toLowerCase();
      const brand=(state.brand||'').toLowerCase();
      const byCat=pool.filter(o=>(o.category||'').toLowerCase()===cat && cat);
      const byBrand=pool.filter(o=>(o.restaurant||'').toLowerCase()===brand && brand);
      const rest=pool.filter(o=>!byCat.includes(o) && !byBrand.includes(o));
      return [...byCat,...byBrand,...rest].slice(0,n);
    }

    async function enableNearbyAlerts(){
      try{
        const perm=await Notification.requestPermission();
        if(perm!=='granted') return alert('Notifications are blocked.');
        if(!navigator.geolocation) return alert('Location not available.');
        navigator.geolocation.getCurrentPosition(async(pos)=>{
          const {latitude,longitude}=pos.coords;
          fetch('/api/event',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'enable_nearby',meta:{latitude,longitude}})});
          alert('Nearby alerts enabled for this device.');
        },()=>alert('Could not get your location.'));
      }catch(e){ alert('Unable to enable alerts.'); }
    }

    return {
      // state/query
      readQuery, writeQuery, debounce,
      // buttons/storage
      updateButtonsFor, isFavorite, isInWallet, toggleFavorite, toggleWallet,
      // filters/UI
      populateBrandFilter, applyFilter,
      // card/sort
      makeCard, suggest, computeNearbySort, sortByNearby,
      // stats/branding
      getStats, initBranding,
      // nearby state
      get __nearbyReady(){ return Boolean(_nearby.brandDist && _nearby.brandDist.size); },
      set __nearbyReady(_v){}
    };
  })();

  // prime stats + branding
  (async()=>{try{await Shared.getStats();}catch{}})();
  document.addEventListener('DOMContentLoaded', ()=>{ if(typeof Shared.initBranding==='function') Shared.initBranding(); });
  </script>

  <!-- ========= Page init ========= -->
  <script>
  (function(){
    async function init(){
      const data = await fetch('/api/offers').then(r=>r.json()).catch(()=>({offers:[]}));
      const offers = data.offers || [];

      // Populate filters
      Shared.populateBrandFilter(offers, document.getElementById('brand'));
      (function(rows, selectEl){
        const seen={};
        rows.forEach(r=>{
          const c=(r.category||'').trim(); if(!c || seen[c]) return; seen[c]=1;
          const o=document.createElement('option'); o.value=c; o.textContent=c; selectEl.appendChild(o);
        });
      })(offers, document.getElementById('category'));

      const state = { q:'', brand:'', category:'', sortNearby:false };

      function readControls(){
        state.q=document.getElementById('q').value.trim();
        state.brand=document.getElementById('brand').value;
        state.category=document.getElementById('category').value;
      }

      function render(){
        const grid=document.getElementById('grid'); grid.innerHTML='';
        let rows=Shared.applyFilter(offers, state);
        if(state.sortNearby && Shared.__nearbyReady){ rows = Shared.sortByNearby(rows); }
        rows.forEach(o=>{
          const card=Shared.makeCard(o);
          grid.appendChild(card);
          if (typeof Shared.updateButtonsFor === 'function') Shared.updateButtonsFor(o.id);
        });
      }

      // events
      document.getElementById('apply').onclick = ()=>{ readControls(); render(); };
      document.getElementById('clear').onclick = ()=>{
        document.getElementById('q').value='';
        document.getElementById('brand').value='';
        document.getElementById('category').value='';
        state.q=''; state.brand=''; state.category='';
        render();
      };
      document.getElementById('btn-near').onclick = ()=>{
        Shared.enableNearbyAlerts();
        Shared.computeNearbySort().then(()=>{ state.sortNearby=true; render(); }).catch(()=>{});
      };

      // try to seed nearby miles, then render
      Shared.computeNearbySort().then(()=>{ render(); }).catch(()=>{ render(); });
    }

    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init);
    else init();
  })();
  </script>
</body>
</html>
