<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Local Deals Hub</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#ffd400">
  <!-- keep your real CSS version here -->
  <link rel="stylesheet" href="/theme.css?v=29b">
  <style>
    #crash{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);color:#fff;z-index:99999;padding:14px;overflow:auto;font:12px/1.4 ui-monospace,monospace}
    #crash b{color:#ffd400} #crash pre{white-space:pre-wrap;word-break:break-word;margin:8px 0 0}
  </style>
</head>
<body>
  <div id="crash"><b>App error</b><pre id="crashmsg"></pre></div>

  <div class="site">
    <header class="header">
      <div class="logo" data-logo>LD</div>
      <div class="title">
        <h1>Local Deals Hub</h1>
        <p>Precision Beats Saturation ‚Äî Every Scan Counts.‚Ñ¢</p>
      </div>
    </header>

    <div class="actionbar">
      <button id="btn-near" class="chip chip--white">üìç Show deals near me</button>
      <a class="chip chip--white" href="/wallet.html?v=28">üí∞ My Wallet</a>
      <a class="chip chip--white" href="/wallet.html?v=28&tab=favorites">‚≠ê My Favorites</a>
    </div>

    <div class="filters">
      <input id="q" class="input" placeholder="Search offers or brand">
      <select id="brand" class="select"><option value="">All brands</option></select>
      <select id="category" class="select" aria-label="Categories"><option value="">All categories</option></select>
      <button id="apply" class="btn-compact">Apply</button>
      <button id="clear" class="btn-compact">Clear</button>
    </div>

    <section id="grid" class="grid">
      <noscript><p style="padding:10px">Enable JavaScript to view offers.</p></noscript>
    </section>

    <footer class="footer">AllCityPages.com | info@AllCityPages.com</footer>
  </div>

  <script>
    // tiny overlay so you never see a blank page
    function crash(msg){
      var el=document.getElementById('crash'); el.style.display='block';
      document.getElementById('crashmsg').textContent=String(msg||'Unknown error');
    }
    window.addEventListener('error', e=>crash(e.error||e.message));
    window.addEventListener('unhandledrejection', e=>crash(e.reason));

    // ---- Try multiple shared.js URLs until one defines window.Shared ----
    (async function boot(){
      const candidates = [
        '/shared.js?v=31.1',
        '/shared.js?v=31',
        '/shared.js?v=30',
        '/shared.js?v=29b',
        '/shared.js?v=29a',
        '/shared.js?v=29',
        '/shared.js'
      ];
      let loadedFrom = null;

      async function loadOne(src){
        return new Promise((resolve, reject)=>{
          const s=document.createElement('script');
          s.src=src; s.async=false;
          s.onload=()=>resolve(src);
          s.onerror=()=>reject(new Error('Failed to load '+src));
          document.head.appendChild(s);
        });
      }

      for (const url of candidates){
        try{
          loadedFrom = await loadOne(url);
          if (window.Shared) break; // success
        }catch(_){} // try next
      }
      if (!window.Shared){
        crash('Could not load shared.js from any of: ' + candidates.join(', '));
        return;
      }

      // ---- Normal page init (safe, vanilla JS) ----
      function ensureIncludes(cardEl, offer){
        var txt=((offer && (offer.includes||offer.Includes||offer.bundle))||'').trim();
        if(!txt) return;
        var head = cardEl.querySelector('.head-grid') || cardEl.querySelector('.title-row');
        if(!head) return;
        var inc = head.querySelector('.includes-row');
        if(!inc){ inc=document.createElement('div'); inc.className='includes-row'; head.appendChild(inc); }
        inc.textContent='Includes: '+txt;
        inc.style.display='';
      }

      try{
        const data = await fetch('/api/offers').then(r=>r.json()).catch(()=>({offers:[]}));
        const offers = data.offers || [];

        Shared.populateBrandFilter(offers, document.getElementById('brand'));
        (function(rows, sel){
          const seen={};
          rows.forEach(r=>{
            const c=(r.category||'').trim(); if(!c||seen[c]) return; seen[c]=1;
            const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o);
          });
        })(offers, document.getElementById('category'));

        const state={ q:'', brand:'', category:'', sortNearby:false };
        function readControls(){ state.q=document.getElementById('q').value.trim(); state.brand=document.getElementById('brand').value; state.category=document.getElementById('category').value; }

        function render(){
          const grid=document.getElementById('grid'); grid.innerHTML='';
          let rows=Shared.applyFilter(offers,state);
          if(state.sortNearby && Shared.__nearbyReady){ rows=Shared.sortByNearby(rows); }
          rows.forEach(o=>{
            const card=Shared.makeCard(o);
            grid.appendChild(card);
            ensureIncludes(card,o);
            if(typeof Shared.updateButtonsFor==='function') Shared.updateButtonsFor(o.id);
          });
        }

        document.getElementById('apply').onclick=()=>{ readControls(); render(); };
        document.getElementById('clear').onclick=()=>{ document.getElementById('q').value=''; document.getElementById('brand').value=''; document.getElementById('category').value=''; state.q=''; state.brand=''; state.category=''; render(); };
        document.getElementById('btn-near').onclick=async()=>{ await Shared.enableNearbyAlerts(); try{ await Shared.computeNearbySort(); Shared.__nearbyReady=true; state.sortNearby=true; render(); }catch(e){} };

        try{ await Shared.computeNearbySort(); Shared.__nearbyReady=true; }catch(e){}
        render();

      }catch(err){ crash(err); }
    })();
  </script>
</body>
</html>
