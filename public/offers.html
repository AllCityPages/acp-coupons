<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Offers — All City Pages</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#111827">
<style>
  :root { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  body { margin:0; background:#0b1220; color:#e5e7eb; }
  header { position:sticky; top:0; backdrop-filter:saturate(180%) blur(8px); background:rgba(2,6,23,.8); padding:14px 18px; display:flex; gap:12px; align-items:center; z-index:10; }
  header a { color:#93c5fd; text-decoration:none; }
  .wrap { max-width:1100px; margin:0 auto; padding:18px; }
  .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:16px; }
  .card { background:#111827; border:1px solid #1f2937; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; }
  .card img { width:100%; height:160px; object-fit:cover; }
  .body { padding:12px; display:flex; flex-direction:column; gap:8px; }
  .title { font-weight:700; }
  .brand { color:#94a3b8; font-size:13px; }
  .btn { display:inline-block; text-align:center; border:0; border-radius:10px; padding:10px 12px; cursor:pointer; color:#fff; background:#2563eb; }
  .btn.secondary { background:#f97316; }
  .btn[disabled] { opacity:.6; cursor:default; }
  .row { display:flex; gap:8px; }
  .filters { display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 16px; }
  input[type="search"]{ padding:10px; border-radius:10px; border:1px solid #334155; background:#0f172a; color:#e2e8f0; }
  select{ padding:10px; border-radius:10px; border:1px solid #334155; background:#0f172a; color:#e2e8f0; }
  .notice { font-size:12px; color:#94a3b8; }
  .msg { color:#94a3b8; padding:12px 0; min-height:24px; }
  .saved-pill { font-size:12px; background:#16a34a; color:#fff; padding:2px 8px; border-radius:999px; margin-left:6px; }
</style>
</head>
<body>
<header>
  <strong>⭐ Offers</strong>
  <a href="/wallet.html">My Wallet</a>
  <span class="notice">Allow notifications for “nearby” alerts.</span>
</header>
<div class="wrap">
  <div class="filters">
    <input id="q" type="search" placeholder="Search offers or brand">
    <select id="brand"><option value="">All brands</option></select>
    <button class="btn" id="apply">Apply</button>
    <button class="btn secondary" id="clear">Clear</button>
  </div>

  <div id="msg" class="msg"></div>
  <div id="grid" class="grid"></div>
</div>

<script>
  const KEY = 'wallet_offers';
  const params = new URLSearchParams(location.search);
  const prefillBrand = params.get('rest') || '';
  const source = params.get('src') || 'gallery';

  const $ = sel => document.querySelector(sel);

  function setMsg(s){ $('#msg').textContent = s || ''; }

  function getSaved(){
    try { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
    catch { return []; }
  }
  function putSaved(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }
  function isSaved(id){ return getSaved().includes(id); }

  async function loadOffers(){
    const res = await fetch('/api/offers');
    if (!res.ok) throw new Error('Failed to load /api/offers');
    const j = await res.json();
    return j.offers || [];
  }

  function cardHTML(o){
    const saved = isSaved(o.id);
    return `
      <div class="card" data-id="${o.id}">
        ${o.hero_image ? `<img src="${o.hero_image}" alt="">` : `<div style="height:160px;background:#0f172a"></div>`}
        <div class="body">
          <div class="title">
            ${o.title}
            ${saved ? `<span class="saved-pill">Saved</span>` : ``}
          </div>
          <div class="brand">${o.restaurant}</div>
          <div class="row">
            <button class="btn save-btn"
                    data-id="${o.id}"
                    data-restaurant="${encodeURIComponent(o.restaurant || '')}"
                    data-client="${o.client_slug || ''}"
                    ${saved ? 'disabled' : ''}>
              ${saved ? 'Saved' : 'Save'}
            </button>
            <a class="btn secondary redeem-btn"
               href="/coupon?offer=${encodeURIComponent(o.id)}"
               data-id="${o.id}"
               data-restaurant="${encodeURIComponent(o.restaurant || '')}"
               data-client="${o.client_slug || ''}">Redeem</a>
          </div>
        </div>
      </div>`;
  }

  function renderGrid(list){
    const grid = $('#grid');
    grid.innerHTML = list.map(cardHTML).join('');
  }

  function applyFilters(){
    const q = ($('#q').value || '').toLowerCase();
    const b = ($('#brand').value || '').toLowerCase();
    const all = window.__offers || [];
    const out = all.filter(o => {
      const matchQ = !q || o.title.toLowerCase().includes(q) || o.restaurant.toLowerCase().includes(q);
      const matchB = !b || o.restaurant.toLowerCase() === b;
      return matchQ && matchB;
    });
    setMsg(out.length ? '' : 'No offers match your filters.');
    renderGrid(out);
  }

  async function saveOffer(id, brand, client_slug){
    // update local wallet
    const cur = getSaved();
    if (!cur.includes(id)) { cur.push(id); putSaved(cur); }

    // update current card state (without reloading)
    const card = document.querySelector(`.card[data-id="${CSS.escape(id)}"]`);
    if (card) {
      const btn = card.querySelector('.save-btn');
      const title = card.querySelector('.title');
      if (btn) { btn.textContent = 'Saved'; btn.setAttribute('disabled',''); }
      if (title && !title.querySelector('.saved-pill')) {
        const pill = document.createElement('span');
        pill.className = 'saved-pill';
        pill.textContent = 'Saved';
        title.appendChild(pill);
      }
    }

    // server logs (non-blocking)
    fetch('/api/save', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ offer_id:id })
    }).catch(()=>{});
    fetch('/api/event', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ type:'save_click', offer_id:id, restaurant:brand, client_slug, meta:{ source } })
    }).catch(()=>{});
  }

  // ONE delegated listener for Save and Redeem
  document.addEventListener('click', (e) => {
    const saveBtn = e.target.closest('.save-btn');
    if (saveBtn) {
      const id = saveBtn.dataset.id;
      if (!id) { alert('Missing offer id'); return; }
      const restaurant = decodeURIComponent(saveBtn.dataset.restaurant || '');
      const client = saveBtn.dataset.client || '';
      saveOffer(id, restaurant, client);
      return;
    }
    const redeemBtn = e.target.closest('.redeem-btn');
    if (redeemBtn) {
      const id = redeemBtn.dataset.id;
      const restaurant = decodeURIComponent(redeemBtn.dataset.restaurant || '');
      const client = redeemBtn.dataset.client || '';
      fetch('/api/event', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ type:'redeem_click', offer_id:id, restaurant, client_slug:client, meta:{ source } })
      }).catch(()=>{});
    }
  });

  async function init(){
    try {
      setMsg('Loading offers…');
      const offers = await loadOffers();
      window.__offers = offers;

      // brands
      const brands = Array.from(new Set(offers.map(o => o.restaurant))).sort();
      const sel = document.getElementById('brand');
      brands.forEach(b => { const opt = document.createElement('option'); opt.value=b; opt.textContent=b; sel.appendChild(opt); });
      if (prefillBrand) sel.value = prefillBrand;

      setMsg('');
      applyFilters();

      document.getElementById('apply').onclick = applyFilters;
      document.getElementById('clear').onclick = ()=>{ document.getElementById('q').value=''; sel.value=''; applyFilters(); };

      if ('serviceWorker' in navigator) navigator.serviceWorker.register('/service-worker.js').catch(()=>{});

      // log gallery view
      fetch('/api/event', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ type:'gallery_view', meta:{ source } })
      }).catch(()=>{});
    } catch (e) {
      console.error(e);
      setMsg('Could not load offers. Check /api/offers and offers.json.');
    }
  }

  init();
</script>
</body>
</html>
