<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Printable Coupon</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    @page { size: Letter; margin: 0.5in; }

    :root{
      --ink:#111827; --muted:#4b5563; --border:#e5e7eb; --bg:#fff;
      --brand:#111827; --accent:#111827;
    }

    html,body{ background:#fff;color:var(--ink);
      font-family:ui-sans-serif,system-ui,Arial; }

    .sheet{
      max-width:8.5in;margin:0 auto;padding:20px;
      border:1px solid var(--border);border-radius:16px;
      box-shadow:0 10px 20px rgba(0,0,0,.05);
    }

    .printbar{display:flex;gap:10px;margin-bottom:14px;}
    .printbar .btn{
      padding:8px 12px;border-radius:10px;
      border:1px solid var(--border);
      background:#fff;cursor:pointer;font-weight:700;
    }
    @media print { .printbar { display:none } .sheet{ box-shadow:none } }

    .head{display:flex;gap:12px;align-items:center;margin-bottom:12px;}
    #logoBox{
      width:48px;height:48px;border-radius:12px;
      border:1px solid #cbd5e1;
      display:grid;place-items:center;
      background:#eef2ff;font-weight:800;font-size:20px;
    }

    h1{margin:0;font-size:24px;}
    .brand{font-size:14px;color:var(--muted);}

    .grid{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin:12px 0;}
    .hero{
      border:1px solid var(--border);border-radius:14px;
      overflow:hidden;background:#f9fafb;
      height:100%;display:flex;align-items:center;justify-content:center;
    }
    .hero img{width:100%;height:auto;object-fit:cover;}

    .qrbox{
      border:1px dashed var(--border);border-radius:14px;
      padding:14px;text-align:center;
    }
    #qr{width:100%;max-width:280px;margin-bottom:10px;}

    #cta{
      display:inline-block;margin-top:6px;
      padding:10px 14px;border-radius:999px;
      font-weight:bold;color:#fff;
      background:var(--accent);
      text-decoration:none;
    }

    .panel{border:1px solid var(--border);border-radius:12px;
      padding:12px;margin-top:10px;}

    #desc{font-size:15px;margin-bottom:10px;}
    #fine{font-size:12px;color:#6b7280;}

    .footer{margin-top:10px;font-size:12px;
      display:flex;justify-content:space-between;color:#6b7280;}
      
    .badge{
      display:inline-block;border-radius:999px;padding:5px 10px;
      font-size:12px;border:1px solid var(--border);margin-top:6px;
    }
    .danger{background:#fee2e2;border-color:#fecaca;color:#b91c1c;}
    .neutral{background:#f3f4f6;border-color:#e5e7eb;color:#6b7280;}
  </style>
</head>
<body>

<div class="sheet">
  <div class="printbar">
    <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
    <a href="/offers.html" class="btn">‚Üê Back</a>
  </div>

  <div class="head">
    <div id="logoBox">A</div>
    <div>
      <h1 id="title">Coupon</h1>
      <div class="brand" id="brand"></div>
    </div>
  </div>

  <div class="grid">
    <div class="hero"><img id="hero" alt=""></div>
    <div class="qrbox">
      <img id="qr" alt="QR">
      <div style="font-size:12px;color:#6b7280">
        Scan to redeem ‚Äî one time only
      </div>
      <a id="cta" href="#">Use Now</a>
    </div>
  </div>

  <div class="panel">
    <div id="desc"></div>
    <span id="expires" class="badge neutral"></span>
  </div>

  <div class="panel">
    <div id="fine">Valid at participating locations.</div>
  </div>

  <div class="footer">
    <span id="slug">AllCityPages ‚Äî Local Deals</span>
    <span>Show cashier to redeem</span>
  </div>
</div>

<script>
(async function(){
  const id = new URL(location.href).searchParams.get('offer');
  if(!id) return document.getElementById('title').textContent='Missing offer id';

  const o = await fetch('/api/offer/' + encodeURIComponent(id)).then(r=>r.json());

  document.documentElement.style.setProperty('--accent', o.brand_color || '#111827');

  document.getElementById('title').textContent = o.title;
  document.getElementById('brand').textContent = o.restaurant || '';
  document.getElementById('desc').textContent = o.description || '';
  document.getElementById('fine').textContent = o.fine_print || '';

  const logoBox = document.getElementById('logoBox');
  if (o.logo){
    logoBox.innerHTML = `<img src="${o.logo}" style="max-width:100%;max-height:100%;">`;
  } else {
    logoBox.textContent = (o.restaurant||'A')[0].toUpperCase();
  }

  document.getElementById('hero').src = o.hero_image || o.logo || '';
  document.getElementById('qr').src   = '/qr?offer=' + encodeURIComponent(id);
  document.getElementById('cta').href = '/coupon?offer=' + encodeURIComponent(id);

  const exp = Number(o.expires_days || 0);
  const badge = document.getElementById('expires');
  if (exp <= 0){
    badge.textContent = 'Expired';
    badge.classList.add('neutral');
    document.getElementById('cta').remove();
  } else if (exp <= 3){
    badge.textContent = `Expires in ${exp} day${exp===1?'':'s'}`;
    badge.classList.add('danger');
  } else {
    badge.textContent = `Expires in ${exp} days`;
  }

  if (new URL(location.href).searchParams.get('autoprint') === '1'){
    setTimeout(()=>window.print(), 300);
  }
})();
</script>

</body>
</html>
