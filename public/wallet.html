<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>My Wallet â€” All City Pages</title>
<meta name="theme-color" content="#111827">
<style>
  :root { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  body { margin:0; background:#0b1220; color:#e5e7eb; }
  header { position:sticky; top:0; backdrop-filter:saturate(180%) blur(8px); background:rgba(2,6,23,.8); padding:14px 18px; display:flex; gap:12px; align-items:center; z-index:10; }
  header a { color:#93c5fd; text-decoration:none; }
  .wrap { max-width:1100px; margin:0 auto; padding:18px; }
  .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:16px; }
  .card { background:#111827; border:1px solid #1f2937; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; }
  .card img { width:100%; height:160px; object-fit:cover; }
  .body { padding:12px; display:flex; flex-direction:column; gap:8px; }
  .title { font-weight:700; }
  .brand { color:#94a3b8; font-size:13px; }
  .btn { display:inline-block; text-align:center; border:0; border-radius:10px; padding:10px 12px; cursor:pointer; color:#fff; background:#f97316; }
  .row { display:flex; gap:8px; }
  .msg { color:#94a3b8; padding:12px 0; min-height:24px; }
</style>
</head>
<body>
<header>
  <strong>ðŸ“¥ My Wallet</strong>
  <a href="/offers.html">Back to Offers</a>
</header>
<div class="wrap">
  <div id="msg" class="msg"></div>
  <div id="grid" class="grid"></div>
</div>

<script>
  const KEY = 'wallet_offers';
  const $ = sel => document.querySelector(sel);

  function getSaved(){
    try { return JSON.parse(localStorage.getItem(KEY) || '[]'); }
    catch { return []; }
  }

  async function loadOffers(){
    const res = await fetch('/api/offers');
    if (!res.ok) throw new Error('Failed to load /api/offers');
    const j = await res.json();
    return j.offers || [];
  }

  function cardFor(offer){
    return `
      <div class="card">
        ${offer.hero_image ? `<img src="${offer.hero_image}" alt="">` : `<div style="height:160px;background:#0f172a"></div>`}
        <div class="body">
          <div class="title">${offer.title}</div>
          <div class="brand">${offer.restaurant || ''}</div>
          <div class="row">
            <a class="btn" href="/coupon?offer=${encodeURIComponent(offer.id)}">Redeem</a>
          </div>
        </div>
      </div>
    `;
  }

  function fallbackCard(id){
    return `
      <div class="card">
        <div style="height:160px;background:#0f172a"></div>
        <div class="body">
          <div class="title">${id}</div>
          <div class="brand">Saved offer (details unavailable)</div>
          <div class="row">
            <a class="btn" href="/coupon?offer=${encodeURIComponent(id)}">Try to Redeem</a>
          </div>
        </div>
      </div>
    `;
  }

  async function init(){
    const saved = getSaved();
    if (!saved.length) {
      $('#msg').textContent = 'You havenâ€™t saved any offers yet.';
      $('#grid').innerHTML = '';
      return;
    }

    try {
      const offers = await loadOffers();
      const byId = Object.fromEntries(offers.map(o => [o.id, o]));
      const cards = saved.map(id => byId[id] ? cardFor(byId[id]) : fallbackCard(id));
      $('#msg').textContent = '';
      $('#grid').innerHTML = cards.join('');
    } catch (e) {
      console.error(e);
      $('#msg').textContent = 'Could not load offers. Showing saved IDs only.';
      $('#grid').innerHTML = saved.map(fallbackCard).join('');
    }
  }

  init();
</script>
</body>
</html>
